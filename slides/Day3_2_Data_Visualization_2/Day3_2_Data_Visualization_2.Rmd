---
title: "Introduction to R for Data Analysis"
subtitle: "Data Visualization Part 2"
author: "Johannes Breuer<br />Stefan JÃ¼nger"
date: "2020-08-05"
location: "GESIS, Cologne, Germany"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "default-fonts", "../workshop.css"]
    nature:
      highlightStyle: "github"
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---
layout: true

```{r setup, include = FALSE}
source("../xaringan_r_setup.R") 
xaringanExtra::use_xaringan_extra(c("tile_view", "clipboard"))
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = TRUE  #<<
)
```

<div class="my-footer">
  <div style="float: left;"><span>`r gsub("<br />", ", ", gsub("<br /><br />|<a.+$", "", metadata$author))`</span></div>
  <div style="float: right;"><span>`r metadata$location`, `r metadata$date`</span></div>
  <div style="text-align: center;"><span>`r gsub(".+<br />", " ", metadata$subtitle)`</span></div>
</div>

```{css, echo = FALSE}
# .remark-slide-content {
#   font-size: 28px;
#   padding: 20px 80px 20px 80px;
# }
# .remark-code, .remark-inline-code {
#   background: #f0f0f0;
# }
# .remark-code {
#   font-size: 24px;
# }
# .huge .remark-code { /*Change made here*/
#   font-size: 200% !important;
# }
.tinyish .remark-code { /*Change made here*/
  font-size: 70% !important;
}
```

---

## What is `ggplot2`?
`ggplot2` is another `R` package for creating plots and is part of the `tidyverse`.


It uses the *grammar of graphics*
- well-suited for multi-dimensional data
- it expects data (frames) as input
- components of the plot are added as layers


```{r plot call, eval = FALSE, echo = TRUE}
plot_call +
  layer_1 +
  layer_2 +
  ... +
  layer_n
```


---
## `ggplot2` examples 
.pull-left[
```{r radar fig, echo = FALSE}
knitr::include_graphics("./pics/143_radar_chart_multi_indiv_2.png")
```
]

.pull-right[
```{r density fig, echo = FALSE}
knitr::include_graphics("./pics/21_ggplot2_ddensity_plot.png")
```
]


<small><small>Sources: https://www.r-graph-gallery.com/wp-content/uploads/2016/05/143_radar_chart_multi_indiv_2.png and https://www.r-graph-gallery.com/wp-content/uploads/2015/09/21_ggplot2_ddensity_plot.png</small></small>

---

## `ggplot2` examples 
.pull-left[
```{r scatter fig, echo = FALSE}
knitr::include_graphics("./pics/51_scatterplot_linear_model_with_CI_ggplot2.png")
```
]

.pull-right[
```{r map fig, echo = FALSE}
knitr::include_graphics("./pics/328_Hexbin_map_USA_4.png")
```
]

<small><small>Sources: https://www.r-graph-gallery.com/wp-content/uploads/2015/11/51_scatterplot_linear_model_with_CI_ggplot2-300x300.png and https://www.r-graph-gallery.com/wp-content/uploads/2017/12/328_Hexbin_map_USA_4-300x200.png</small></small>

---

## Histograms as in base `R`

```{r echo = FALSE}
gp_covid <- 
  haven::read_sav(
    "../../data/gesis_panel_covid19/ZA5667_v1-1-0.sav"
  ) %>% 
  sjlabelled::set_na(na = c(-1:-99, 97))
```

```{r ggplot_histogram, out.width = "65%"}
ggplot(gp_covid, aes(x = age_cat)) + 
  geom_histogram()
```

---

## Components of a plot
According to Wickham (2010, 8)* a layered plot consists of the following components:

<span class="footnote">
<small><small><span class="red bold">*</span> http://dx.doi.org/10.1198/jcgs.2009.07098</small></small>
</span>


- data and aesthetic mappings,

- geometric objects,
- scales,
- and facet specification


```{r plot call example, eval = FALSE, echo = TRUE}
plot_call +
  data +
  aesthetics +
  geometries +
  scales +
  facets
```

---

## Data requirements
You can use one single data frame to create a plot in `ggplot2`.
- everything on the plot is just data
- creates a smooth workflow from data wrangling to the final presentation of the results

```{r data_science_pic, out.width = "70%", echo = FALSE}
knitr::include_graphics("./pics/data-science_man.png")
```

<small><small>Source: http://r4ds.had.co.nz</small></small>

However, this makes it difficult to add extra features to your plot.
- There are ways of doing it anyway
- Yet, it requires thinking about what to plot

---

## Why the long format? `r ji("horse")`
`ggplot2` prefers data in the long data format (NB: Of course, only if this is possible and makes sense for the dataset at hand)
- in some scientific disciplines this format is only used for specialized analyses (e.g., time series analysis)

.pull-left[
We may want to get used to it as this format has some benefits:
- every element we aim to plot is an observation
- no thinking required how a specific variable relates to an observation
- most importantly, the long format is more parsimonious
  - it requires less memory and less disk space
]

.pull-right[
```{r long_pic, out.width = "40%", echo = FALSE}
knitr::include_graphics("./pics/long.png")
```
<small><small>Source: https://github.com/gadenbuie/tidyexplain#tidy-data</small></small>
]
  
---

## Creating your own plot

We do not want to give a lecture on the theory behind data visualization.
- creating plots is all about practice
- ...and 'borrowing' code from others

.column-left-half[
```{r pseudo, eval = FALSE, echo = TRUE}
please +
  no +
  more +
  pseudo +
  code +
  man
```
]

.column-right-half[
Three components are important:
- Plot initiation
- data input
- aesthetics definition
- so-called geoms
]

---

## Plot initiation

.pull-left[
`ggplot()` is the most basic command to create a plot:

```{r ggplot_basic, eval = FALSE}
ggplot()
```
]

.pull-right[
```{r ref.label = "ggplot_basic", echo = FALSE}
```
]

**But it doesn't show anything...**

---

## Data input

.pull-left[
As we've already learned `ggplot()` expects data as input

```{r load_gapminder_data, message = F, echo = FALSE}
gapminder_children <- 
  readr::read_csv(
    "../../data/gapminder/children_per_woman_total_fertility.csv"
    ) %>% 
  tidyr::pivot_longer(
    -country, 
    names_to = "year",
    values_to = "children"
  ) %>% 
  dplyr::left_join(
      readr::read_csv(
    "../../data/gapminder/countries_continent.csv"
      )
  ) %>% 
  dplyr::filter(year >= 1950) %>% 
  dplyr::mutate(
    year = as.numeric(year),
    continent = as.factor(continent)
    ) %>% 
  tidyr::drop_na()

```

```{r ggplot_data, eval = FALSE}
ggplot(data = gapminder_children)
```
]

.pull-right[
```{r ref.label = "ggplot_data", echo = FALSE}
```
]

**Still nothing there...**


---

## `aes`thetics! 

.pull-left[
`ggplot` requires information about the variables to plot

```{r ggplot_aes, eval = FALSE}
ggplot(data = gapminder_children) +
  aes(x = year, y = children)
```
]

.pull-right[
```{r ref.label = "ggplot_aes", echo = FALSE}
```
]

**That's a little bit better, right?**

---

## `geom`s!
.pull-left[
Finally, `ggplot` needs information *how* to plot the variables

```{r ggplot_geom, eval = FALSE}
ggplot(data = gapminder_children) +
  aes(x = year, y = children) +
  geom_point()
```
]

--

.pull-right[
```{r ref.label = "ggplot_geom", echo = FALSE}
```
]

**A scatter plot!**

---

## Add a line
.pull-left[
We can also add more than one `geom`

```{r ggplot_line, eval = FALSE}
ggplot(data = gapminder_children) +
  aes(x = year, y = children) +
  geom_point() +
  geom_smooth()
```
]

.pull-right[
```{r ref.label = "ggplot_line", echo = FALSE}
```
]


**A smoothed regression line!**

---

## Going further: adding group `aes`thetics

.pull-left[
We can add different colors for different groups in our data

```{r ggplot_group, eval = FALSE}
ggplot(
  data = gapminder_children,
  aes(
    x = year, 
    y = children, 
    color = continent,
    group = continent
    )
  ) +
  geom_smooth()
```
]

.pull-right[
```{r ref.label = "ggplot_group", echo = FALSE}
```
]

---

## Manipulating group `aes`thetics

.pull-left[
We can also change the colors that are used in the plot

```{r ggplot_group_man, eval = FALSE}
ggplot(
  data = gapminder_children,
  aes(
    x = year, 
    y = children, 
    color = continent,
    group = continent
    )
  ) +
  geom_smooth() +
  scale_color_brewer(palette = "Paired")
```
]

.pull-right[
```{r ref.label = "ggplot_group_man", echo = FALSE}
```
]

---

## Colors and `theme`s

One particular strength of `ggplot2` lies in its theming capabilities. The package has some built-in theme functions that makes theming a plot fairly easy, e.g.,
- `theme_bw()`
- `theme_dark()`
- `theme_void()`
- etc.

See: https://ggplot2.tidyverse.org/reference/ggtheme.html


If you want to, you can play around with some of those themes in the exercises for this session.

In general, the [`r-color-palettes` repository by Emil Hvitfeldt](https://github.com/EmilHvitfeldt/r-color-palettes) is a good resource for choosing color palettes in `R`.

---

## Alternative to being too colorful: facets
.pull-left[
```{r facet_wrap, eval = FALSE}
ggplot(
  data = gapminder_children,
  aes(
    x = year, 
    y = children
    )
  ) +
  geom_smooth(color = "black") +
  facet_wrap(~continent, ncol = 3) +
  theme_bw()
```
]

.pull-right[
```{r ref.label = "facet_wrap", echo = FALSE}
```
]

---

## The `theme()` argument
The most direct interface for manipulating your theme is the `theme()` argument. Here you can change the appearance of
- axis labels
- captions and titles
- legend
- grid layout
- the wrapping strips
- ...

---

## Example: changing the grid layout & axis labels
.pull-left[
```{r theming, eval = FALSE}
ggplot(
  data = gapminder_children,
  aes(
    x = year, 
    y = children
    )
  ) +
  geom_smooth(color = "black") +
  facet_wrap(~continent, ncol = 3) +
  theme_bw() +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    strip.background = element_rect(fill = "white")
  ) + 
  ylab("Number of Children") +
  xlab("Year")
```
]

.pull-right[
```{r ref.label = "theming", echo = FALSE}
```
]

---

## Another on manipulations

.pull-left[
Working with combined aesthetics and different data inputs can become cumbersome.

Particularly, plotting similar aesthetics which interfere with the automatic procedures can create conflicts.

Some 'favorites' include:
- Multiple legends
- and various color scales for similar geoms 
- ... and there's more!
]

.pull-right[
```{r der_schrei, echo = FALSE}
knitr::include_graphics("./pics/800px-The_Scream.jpg")
```
]

.right[
<small><small>Source: https://de.wikipedia.org/wiki/Der_Schrei#/media/File:The_Scream.jpg</small></small>
]

---

## Boxplots
```{r}
ggplot(
  data = 
    gapminder_children %>% 
    dplyr::filter(year == 2018),
  aes(
    y = children,
    x = continent
    )
  ) +
  geom_boxplot() +
  theme_bw()
```

---

## Densities
```{r}
ggplot(
  data = 
    gapminder_children %>% 
    dplyr::mutate(year = as.factor(year)) %>% 
    dplyr::filter(year == 2018 | year == 1990 | year == 1950),
  aes(
    x = children,
    group = year,
    fill = year
    )
  ) +
  geom_density(alpha = .5) +
  facet_wrap(~continent, nrow = 3) +
  scale_fill_brewer(palette = "Spectral") +
  theme_bw() 
```


---

## Shortcuts

`ggplot2` is powerful...
- yet, it is admittedly somewhat complicated to use in the beginning
- and it has a steep learning curve

However, there are some convenient shortcuts that you can use for creating simple plots.

---

## `qplot()` or `quickplot()`

.pull-left[
```{r qplot_example, eval = FALSE}
qplot(
  x = gapminder_children$year, 
  y = gapminder_children$children,
  geom = "point",
  group = gapminder_children$continent
  )
```
]

--

.pull-right[
```{r ref.label = "qplot_example", echo = FALSE}
```
]

---

## `qplot()` or `quickplot()`

.pull-left[
```{r qplot_example_2, eval = FALSE}
qplot(
  x = gapminder_children$year, 
  y = gapminder_children$children,
  geom = c("point", "smooth")
  )
```
]

.pull-right[
```{r ref.label = "qplot_example_2", echo = FALSE}
```
]

---

## Exporting ggplot graphics
Exporting ggplot graphics is fairly easy with the `ggsave()` function. It automatically detects the file format. Also, you can define the plot height, with and dpi, which is particularly useful to get high-class graphics for publication.

```{r eval = FALSE}
nice_plot <- 
  qplot(
    x = gapminder_children$year, 
    y = gapminder_children$children,
    geom = c("point", "smooth")
  )

ggsave("nice_plot.png", nice_plot)
```


---

# Some additional resources

- [ggplot2 - Elegant Graphics for Data Analysis](https://www.springer.com/gp/book/9783319242750) by Hadley Wickham

- [Chapter 3](https://r4ds.had.co.nz/data-visualisation.html) in *R for Data Science*

- [Fundamentals of Data Visualization](https://serialmentor.com/dataviz/) by Claus O. Wilke

- [Data Visualization - A Practical Introduction](https://press.princeton.edu/titles/13826.html) by Kieran Healy

- [data-to-viz](https://www.data-to-viz.com/)

- [R Graph Gallery](https://www.r-graph-gallery.com/)

- [BBC Visual and Data Journalism cookbook for R graphics](https://bbc.github.io/rcookbook/#how_to_create_bbc_style_graphics)

- [ggplot2 extensions](http://www.ggplot2-exts.org/gallery/)

---

class: center, middle

# [Exercise](https://jobreu.github.io/tidyverse-workshop-gesis-2019/exercises/B4_ggplot2Basics_exercises_question.html) time `r ji("weight_lifting_woman")``r ji("muscle")``r ji("running_man")``r ji("biking_man")`

## [Solutions](https://jobreu.github.io/tidyverse-workshop-gesis-2019/solutions/B4_ggplot2Basics_exercises_solution.html)